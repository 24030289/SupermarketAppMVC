<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

  <%- include("partials/navbar", { user: user }) %>

  <div class="container mt-4">
    <h2>Checkout Summary</h2>

    <% if (!cart || cart.length === 0) { %>
      <div class="alert alert-warning mt-3">
        Your cart is empty. <a href="/shopping">Go back shopping</a>.
      </div>
    <% } else { %>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Product</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Subtotal</th>
          </tr>
        </thead>

        <tbody>
          <% let total = 0; %>
          <% cart.forEach(item => { %>
            <% const price = Number(item.price) || 0; %>
            <% const qty = Number(item.quantity) || 0; %>
            <% const sub = price * qty; %>
            <tr>
              <td><%= item.productName %></td>
              <td><%= qty %></td>
              <td>$<%= price.toFixed(2) %></td>
              <td>$<%= sub.toFixed(2) %></td>
            </tr>
            <% total += sub; %>
          <% }) %>
        </tbody>
      </table>

      <h4 class="mb-3">Total: $<%= total.toFixed(2) %></h4>

      <!-- ========================= -->
      <!-- PayPal Payment Section -->
      <!-- ========================= -->
      <div class="card p-3 mb-3">
        <h5 class="mb-2">Pay with PayPal</h5>

        <div id="paypal-button-container"></div>

        <small class="text-muted d-block mt-2">
          After payment is successful, your order will be confirmed automatically.
        </small>
      </div>

      <!-- ========================= -->
      <!-- NETS QR Payment Section -->
      <!-- ========================= -->
      <div class="card p-3 mb-3">
        <h5 class="mb-2">Pay with NETS QR</h5>

        <form action="/nets-qr" method="POST">
          <input type="hidden" name="totalAmount" value="<%= total.toFixed(2) %>">
          <button class="btn btn-danger">Generate NETS QR</button>
        </form>

        <small class="text-muted d-block mt-2">
          You will be redirected to scan a NETS QR code.
        </small>
      </div>

      <!-- IMPORTANT: Replace YOUR_SANDBOX_CLIENT_ID with your real sandbox client id -->
      <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD"></script>

      <script>
        const totalAmount = "<%= total.toFixed(2) %>";

        paypal.Buttons({

          createOrder: async function () {
            const res = await fetch("/api/paypal/create-order", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ totalAmount })
            });

            const data = await res.json();

            if (!data.id) {
              console.error("Create order failed:", data);
              alert("PayPal order creation failed.");
              throw new Error("No order ID returned from server");
            }

            return data.id;
          },

          onApprove: async function (data) {
            const res = await fetch("/api/paypal/capture-order", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ orderID: data.orderID })
            });

            const captureData = await res.json();
            console.log("Capture response:", captureData);

            if (captureData && captureData.status === "COMPLETED") {
              window.location.href = "/checkout/finalize?paypalOrderId=" + encodeURIComponent(data.orderID);
            } else {
              alert("Payment not completed. Please try again.");
            }
          },

          onCancel: function () {
            alert("Payment cancelled.");
          },

          onError: function (err) {
            console.error("PayPal Error:", err);
            alert("Something went wrong with PayPal payment.");
          }

        }).render("#paypal-button-container");
      </script>

    <% } %>
  </div>

</body>
</html>
